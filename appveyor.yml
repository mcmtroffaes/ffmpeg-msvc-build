version: 1.0.{build}
image: Visual Studio 2019
environment:
  APPVEYOR_SAVE_CACHE_ON_ERROR: true
  APPVEYOR_CACHE_ENTRY_ZIP_ARGS: -t7z -m0=lzma -mx=9
  RUN_EXPORT: false
  TRIPLET: x64-windows-static-md

  matrix:
    # minimal build
    ###################
    - FEATURES: core

    # LGPL full builds
    ###################
    - FEATURES: core,avcodec,avformat,avdevice,avfilter,swresample,swscale,nvcodec,opus,vpx
      TRIPLET: x64-windows
      RUN_EXPORT: true
    - FEATURES: core,avcodec,avformat,avdevice,avfilter,swresample,swscale,nvcodec,opus,vpx
      TRIPLET: x64-windows-static
      RUN_EXPORT: true
    - FEATURES: core,avcodec,avformat,avdevice,avfilter,swresample,swscale,nvcodec,opus,vpx
      TRIPLET: x64-windows-static-md
      RUN_EXPORT: true

    # GPL full builds
    ##################
    # TIMEOUT
    #- FEATURES: core,avcodec,avformat,avdevice,avfilter,swresample,swscale,nvcodec,opus,snappy,soxr,vpx,postproc,x264,x265
    #  RUN_EXPORT: true

    # LGPL features
    ################
    - FEATURES: core,avcodec
    - FEATURES: core,avcodec
      TRIPLET: x64-windows  # extra test, tends to break
    - FEATURES: core,avformat
    - FEATURES: core,avdevice
    - FEATURES: core,avfilter
    - FEATURES: core,avfilter
      TRIPLET: x64-windows  # extra test, tends to break
    - FEATURES: core,swresample
    - FEATURES: core,swscale
    - FEATURES: core,bzip2,avformat
    - FEATURES: core,ffmpeg
    - FEATURES: core,ffplay
    - FEATURES: core,ffprobe
    - FEATURES: core,ass,avfilter
    - FEATURES: core,dav1d,avcodec
    - FEATURES: core,freetype,avfilter
    - FEATURES: core,freetype,fontconfig,fribidi,avfilter
      TRIPLET: x64-windows  # for now, see https://github.com/microsoft/vcpkg/issues/15303
    - FEATURES: core,iconv,avcodec
    - FEATURES: core,ilbc,avcodec
    - FEATURES: core,lzma,avformat
    - FEATURES: core,modplug,avformat
      TRIPLET: x64-windows  # vcpkg only supports dynamic build
    - FEATURES: core,mp3lame,avcodec
    - FEATURES: core,nvcodec,avcodec
    - FEATURES: core,opencl,avfilter
    - FEATURES: core,opengl,avdevice
    - FEATURES: core,openh264,avcodec
    - FEATURES: core,openjpeg,avcodec
    - FEATURES: core,opus,avcodec
    - FEATURES: core,sdl2,avdevice
    - FEATURES: core,snappy,avcodec
    - FEATURES: core,soxr,swresample
    - FEATURES: core,ssh,avformat
    #- FEATURES: core,tensorflow,avfilter,swscale  # timeout
    #  TRIPLET: x64-windows  # vcpkg only supports dynamic build
    - FEATURES: core,tesseract,avfilter
      TRIPLET: x64-windows  # vcpkg only supports dynamic build
    - FEATURES: core,speex,avcodec
    - FEATURES: core,theora,avcodec
    - FEATURES: core,vorbis,avcodec
    - FEATURES: core,vpx,avcodec
    - FEATURES: core,webp,avcodec
    - FEATURES: core,xml2,avformat
      TRIPLET: x64-windows  # vcpkg only supports dynamic build
    - FEATURES: core,zlib,avformat

    # GPL features
    ###############
    - FEATURES: core,avisynthplus,avformat
      TRIPLET: x64-windows  # vcpkg only supports dynamic build
    - FEATURES: core,postproc
    - FEATURES: core,x264,avcodec
    - FEATURES: core,x265,avcodec

    # nonfree features
    ###################
    - FEATURES: core,openssl,avformat
    - FEATURES: core,fdk-aac,avcodec

    # 32-bit build
    ###############
    - FEATURES: core,avcodec
      TRIPLET: x86-windows
matrix:
  fast_finish: false
platform:
  - x64
install:
  # note: must remove git from PATH to fix libssh build failure
  # note: creating downloads folder; see https://github.com/microsoft/vcpkg/issues/18291
  - cmd: |
      set /p VCPKG_HASH=<VCPKG_HASH.txt
      cd C:\Tools\vcpkg
      git log -1
      git remote add mcmtroffaes https://github.com/mcmtroffaes/vcpkg.git
      git fetch mcmtroffaes
      git checkout %VCPKG_HASH% -d
      git log -1
      echo %PATH%
      set PATH=%PATH:C:\Program Files\Git\cmd;=%
      md downloads
      .\bootstrap-vcpkg.bat -disableMetrics
      .\vcpkg.exe integrate install
      .\vcpkg.exe upgrade --no-dry-run
      .\vcpkg.exe install pkgconf:%TRIPLET%
      .\vcpkg.exe install ffmpeg[%FEATURES%]:%TRIPLET% --recurse
      dir /s /b "installed\%TRIPLET%"
      cd C:\projects\ffmpeg-msvc-build\
build_script:
  - ps: |
      if ($env:RUN_EXPORT -Eq "true" -And $env:APPVEYOR_REPO_TAG -Eq "true") {
        .\export.ps1 -triplet $env:TRIPLET -features $env:FEATURES -ErrorAction Stop
      }
test_script:
  - cmd: |
      C:\projects\ffmpeg-msvc-build\test.bat C:\Tools\vcpkg %TRIPLET%
on_finish:
  - cmd: |
      cd C:\Tools\vcpkg
      7z a logs.7z -ir!".\*.log"
      appveyor PushArtifact logs.7z
deploy:
  description: "Headers and libraries for FFmpeg.\n\nFeatures: $(FEATURES)."
  provider: GitHub
  auth_token:
    secure: QSdxjkooPHApqh95gD9duaZBxmv/5zWzDcukjNQGmbedwEu0BvzgA6HUEXpvni25
  artifact: /ffmpeg.*\.7z/
  draft: false
  prerelease: false
  on:
    APPVEYOR_REPO_TAG: true
    RUN_EXPORT: true
cache:
  - c:\tools\vcpkg\installed\
