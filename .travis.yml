language: cpp
os:
- osx
- linux
env:
  # minimal build
  ###################
  - FEATURES=core

  # LGPL full builds
  ###################
  - FEATURES=core,avcodec,avformat,avdevice,avfilter,swresample,swscale,opus,vpx

  # LGPL features
  ################
  - FEATURES=core,avcodec
  - FEATURES=core,avformat
  - FEATURES=core,avdevice
  - FEATURES=core,avfilter
  - FEATURES=core,swresample
  - FEATURES=core,swscale
  - FEATURES=core,ffmpeg
  - FEATURES=core,ffplay
  - FEATURES=core,ffprobe
  - FEATURES=core,ass,avfilter
  - FEATURES=core,bzip2,avformat
  - FEATURES=core,dav1d,avcodec
  - FEATURES=core,freetype,avfilter
  - FEATURES=core,freetype,fontconfig,fribidi,avfilter
  - FEATURES=core,iconv,avcodec
  - FEATURES=core,ilbc,avcodec
  - FEATURES=core,lzma,avformat
  - FEATURES=core,modplug,avformat
  - FEATURES=core,mp3lame,avcodec
  - FEATURES=core,nvcodec,avcodec
  - FEATURES=core,opencl,avfilter
  - FEATURES=core,opengl,avdevice
  - FEATURES=core,openh264,avcodec
  - FEATURES=core,openjpeg,avcodec
  - FEATURES=core,opus,avcodec
  - FEATURES=core,sdl2,avdevice
  - FEATURES=core,snappy,avcodec
  - FEATURES=core,soxr,swresample
  - FEATURES=core,ssh,avformat
  #- FEATURES=core,tensorflow,avfilter,swscale  # timeout
  - FEATURES=core,tesseract,avfilter
  - FEATURES=core,theora,avcodec
  - FEATURES=core,vorbis,avcodec
  - FEATURES=core,vpx,avcodec
  - FEATURES=core,webp,avcodec
  - FEATURES=core,xml2,avformat
  - FEATURES=core,zlib,avformat

  # GPL features
  ###############
  #- FEATURES=core,avisynthplus,avformat  # windows only
  - FEATURES=core,postproc
  - FEATURES=core,x264,avcodec
  - FEATURES=core,x265,avcodec

  # nonfree features
  ###################
  - FEATURES=core,openssl,avformat
  - FEATURES=core,fdk-aac,avcodec

dist: focal
osx_image: xcode12u
jobs:
  # known broken features
  allow_failures:
  - env: FEATURES=core,ffplay
    os: osx
  - env: FEATURES=core,ass,avfilter
    os: linux
  - env: FEATURES=core,dav1d,avcodec
    os: osx
  - env: FEATURES=core,freetype,avfilter
    os: linux
  - env: FEATURES=core,freetype,fontconfig,fribidi,avfilter
    os: linux
  - env: FEATURES=core,ssh,avformat
  - env: FEATURES=core,sdl2,avdevice
    os: osx
  - env: FEATURES=core,tesseract,avfilter
  - env: FEATURES=core,xml2,avformat
  exclude:
  # nvcodec is not supported on osx
  - env: FEATURES=core,nvcodec,avcodec
    os: osx
addons:
  apt:
    packages:
    - nasm
    - ninja-build
    - gperf  # required for fontconfig[core]
    - mesa-common-dev  # required for opengl feature
  homebrew:
    packages:
    - nasm
    - ninja
before_install:
  - |
    if [[ "${TRAVIS_OS_NAME}" == "osx" ]]; then
      # get a recent cmake with framework support for PkgConfig
      wget https://github.com/Kitware/CMake/releases/download/v3.20.2/cmake-3.20.2-macos-universal.tar.gz && tar xfz cmake-3.20.2-macos-universal.tar.gz
      export PATH=`pwd`/cmake-3.20.2-macos-universal/CMake.app/Contents/bin:$PATH
    fi
  - cmake --version
install:
  # cannot clone in existing folder so setup vcpkg2 where cache is stored
  - mkdir -p ${TRAVIS_BUILD_DIR}/vcpkg2
  - cd ${TRAVIS_BUILD_DIR}/vcpkg2
  - git init
  - git remote add origin https://github.com/mcmtroffaes/vcpkg.git
  - git fetch origin
  - git checkout --detach `cat ${TRAVIS_BUILD_DIR}/VCPKG_HASH.txt`
  - |
    if [[ "${TRAVIS_OS_NAME}" == "osx" ]]; then
      wget https://github.com/microsoft/vcpkg-tool/releases/download/2021-05-05-9f849c4c43e50d1b16186ae76681c27b0c1be9d9/vcpkg-macos -O vcpkg
      chmod +x vcpkg
    else
      ./bootstrap-vcpkg.sh -disableMetrics -useSystemBinaries
    fi
  - travis_wait 45 ./vcpkg upgrade --no-dry-run
  - travis_wait 45 ./vcpkg install ffmpeg[${FEATURES}] || { cat ${TRAVIS_BUILD_DIR}/vcpkg2/buildtrees/ffmpeg/build-x64-${TRAVIS_OS_NAME}-rel-out.log; false; }
script:
  - ${TRAVIS_BUILD_DIR}/test.sh ${TRAVIS_BUILD_DIR}/vcpkg2 x64-${TRAVIS_OS_NAME}
cache:
  directories:
  - vcpkg2/installed
