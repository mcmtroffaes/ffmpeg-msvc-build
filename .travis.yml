language: cpp
os:
- osx
- linux
env:
  # minimal build
  ###################
  - FEATURES=core

  # LGPL full builds
  ###################
  - FEATURES=core,avcodec,avformat,avdevice,avfilter,swresample,swscale,openh264,opus,vpx

  # LGPL features
  ################
  - FEATURES=core,avcodec
  - FEATURES=core,avformat
  - FEATURES=core,avdevice
  - FEATURES=core,avfilter
  - FEATURES=core,swresample
  - FEATURES=core,swscale
  - FEATURES=core,avresample
  - FEATURES=core,ffmpeg
  - FEATURES=core,ffplay
  - FEATURES=core,ffprobe
  - FEATURES=core,ass,avfilter
  - FEATURES=core,bzip2,avformat
  - FEATURES=core,dav1d,avcodec
  - FEATURES=core,freetype,avfilter
  - FEATURES=core,freetype,fontconfig,fribidi,avfilter
  - FEATURES=core,iconv,avcodec
  - FEATURES=core,ilbc,avcodec
  - FEATURES=core,lzma,avformat
  - FEATURES=core,modplug,avformat
  - FEATURES=core,mp3lame,avcodec
  - FEATURES=core,nvcodec,avcodec
  - FEATURES=core,opencl,avfilter
  - FEATURES=core,opengl,avdevice
  - FEATURES=core,openh264,avcodec
  - FEATURES=core,openjpeg,avcodec
  - FEATURES=core,opus,avcodec
  - FEATURES=core,sdl2,avdevice
  - FEATURES=core,snappy,avcodec
  - FEATURES=core,soxr,swresample
  - FEATURES=core,ssh,avformat
  #- FEATURES=core,tensorflow,avfilter,swscale  # timeout
  - FEATURES=core,tesseract,avfilter
  - FEATURES=core,theora,avcodec
  - FEATURES=core,vorbis,avcodec
  - FEATURES=core,vpx,avcodec
  - FEATURES=core,webp,avcodec
  - FEATURES=core,xml2,avformat
  - FEATURES=core,zlib,avformat

  # GPL features
  ###############
  #- FEATURES=core,avisynthplus,avformat  # windows only
  - FEATURES=core,postproc
  - FEATURES=core,x264,avcodec
  - FEATURES=core,x265,avcodec

  # nonfree features
  ###################
  - FEATURES=core,openssl,avformat
  - FEATURES=core,fdk-aac,avcodec

dist: focal
osx_image: xcode12u
jobs:
  # known broken features
  allow_failures:
  - env: FEATURES=core,ffplay
    os: osx
  - env: FEATURES=core,ass,avfilter
    os: linux
  - env: FEATURES=core,dav1d,avcodec
    os: osx
  - env: FEATURES=core,freetype,avfilter
    os: linux
  - env: FEATURES=core,freetype,fontconfig,fribidi,avfilter
    os: linux
  - env: FEATURES=core,ssh,avformat
  - env: FEATURES=core,sdl2,avdevice
    os: osx
  - env: FEATURES=core,tesseract,avfilter
  - env: FEATURES=core,xml2,avformat
  exclude:
  # nvcodec is not supported on osx
  - env: FEATURES=core,nvcodec,avcodec
    os: osx
addons:
  apt:
    packages:
    - nasm
    - ninja-build
    - gperf  # required for fontconfig[core]
    - mesa-common-dev  # required for opengl feature
  homebrew:
    packages:
    - nasm
    - ninja
before_install:
  - cmake --version
install:
  # cannot clone in existing folder so setup vcpkg2 where cache is stored
  - mkdir -p ${TRAVIS_BUILD_DIR}/vcpkg2
  - cd ${TRAVIS_BUILD_DIR}/vcpkg2
  - git init
  - git remote add origin https://github.com/mcmtroffaes/vcpkg.git
  - git fetch origin
  - git checkout --detach `cat ${TRAVIS_BUILD_DIR}/VCPKG_HASH.txt`
  - ./bootstrap-vcpkg.sh -disableMetrics -useSystemBinaries
  - travis_wait 45 ./vcpkg upgrade --no-dry-run
  - travis_wait 45 ./vcpkg install ffmpeg[${FEATURES}] || { cat ${TRAVIS_BUILD_DIR}/vcpkg2/buildtrees/ffmpeg/build-x64-${TRAVIS_OS_NAME}-rel-out.log; false; }
script:
  - cd ${TRAVIS_BUILD_DIR}
  - mkdir build-rel
  - cd build-rel
  - cmake ../test -DCMAKE_BUILD_TYPE=RELEASE -DCMAKE_TOOLCHAIN_FILE=${TRAVIS_BUILD_DIR}/vcpkg2/scripts/buildsystems/vcpkg.cmake -DFEATURES=${FEATURES//,/;}
  - cmake --build .
  - ctest -V
  - cd ..
  - mkdir build-dbg
  - cd build-dbg
  - cmake ../test -DCMAKE_BUILD_TYPE=DEBUG -DCMAKE_TOOLCHAIN_FILE=${TRAVIS_BUILD_DIR}/vcpkg2/scripts/buildsystems/vcpkg.cmake -DFEATURES=${FEATURES//,/;}
  - cmake --build .
  - ctest -V
cache:
  directories:
  - vcpkg2/installed
